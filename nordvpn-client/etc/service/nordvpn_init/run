#!/bin/sh

# Wait for the nordvpnd socket, which indicates the daemon is ready
while [ ! -S /run/nordvpn/nordvpnd.sock ]; do
    echo "Waiting for NordVPN daemon to create /run/nordvpn/nordvpnd.sock..."
    sleep 2
done

echo "NordVPN daemon socket found, proceeding with login/connect..."

# Example token-based login (or skip if you already have credentials saved):
if [ -n "${NORDVPN_TOKEN}" ]; then
  echo "Logging in via token..."
  nordvpn login --token "${NORDVPN_TOKEN}" || true
fi

# Example settings
if [ -n "${TECHNOLOGY}" ]; then
  nordvpn set technology "${TECHNOLOGY}"
fi

# Whitelist port 22 (SSH):
#nordvpn allowlist add port 22

# Or whitelist your LAN subnet if you want full LAN access:
if [ -n "${LOCAL_NETWORK}" ]; then
  nordvpn allowlist add subnet "${LOCAL_NETWORK}"
fi


# Some users like killswitch, autoconnect, etc.
nordvpn set killswitch on
nordvpn set autoconnect on

# Connect (no argument = best server, or specify e.g. "Denmark", "Germany", etc.)
nordvpn connect ${SERVER}

# Keep this service from exiting, so runit doesn't constantly restart it
echo "NordVPN is connected. Service will now idle..."
exec tail -f /dev/null
